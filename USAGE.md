# HYPay 机器人使用说明书

本文档详细介绍了 HYPay 记账机器人的所有功能和使用方法，涵盖新手入门、日常记账、系统设置及管理员操作。

## 📖 目录
1. [新手入门](#1-新手入门)
2. [日常记账指令](#2-日常记账指令)
3. [系统设置与管理](#3-系统设置与管理)
4. [实用工具](#4-实用工具)
5. [技术特性与说明](#5-技术特性与说明)

---

## 1. 新手入门

### 1.1 申请试用
如果您是首次使用，可以通过以下步骤申请试用：
1. **私聊机器人**：找到机器人账号，点击底部的 **「试用」** 按钮。
2. **等待审核**：系统会自动提交申请，管理员后台会收到通知。
3. **获取权限**：审核通过后，您将获得试用权限（默认 1 天），届时机器人会发送通知。

### 1.2 激活与入群
- **拉入群组**：将机器人邀请进入您的 Telegram 群组。
- **设为管理员**：为了确保机器人能正常读取指令和发送消息，**必须**将机器人设为群组管理员。
- **开启记账**：在群内发送 **「开始」** 指令，即可初始化当天的记账周期。

### 1.3 授权码激活
如果您购买了正式授权码（例如 `HY-XXXX-XXXX`）：
- 在群内发送 `/activate HY-XXXX-XXXX` 即可激活当前群组的授权。

---

## 2. 日常记账指令

以下指令均在**群组内**发送，支持忽略前导空格。

### 2.1 入款与下发
| 动作 | 指令示例 | 说明 |
| :--- | :--- | :--- |
| **入款** | `+100` 或 `入款100` | 记录一笔 100 元的入款 |
| **修正入款** | `+-100` 或 `入款-100` | 扣除 100 元入款（用于记错回滚） |
| **下发 (RMB)** | `下发100` | 记录一笔 100 元的下发 |
| **下发 (USDT)** | `下发100u` | 记录 100 USDT 下发（需先设置美元汇率） |

### 2.2 账单查询与管理
| 动作 | 指令示例 | 说明 |
| :--- | :--- | :--- |
| **显示账单** | `显示账单` | 查看今日总入款、下发、费率及最近 5 笔明细 |
| **开启记录** | `开始` | 开启今日记账（每日开始前必须发送） |
| **结束记录** | `结束记录` | 停止今日记账，不再接收新流水 |
| **清理数据** | `清理今天数据` | **⚠️ 慎用**：清空今日所有流水记录 |

> **注意**：每日账单统计周期为 **北京时间 4:00 至次日 4:00**，系统会自动重置。

---

## 3. 系统设置与管理

### 3.1 费率与汇率设置
| 设置项 | 指令示例 | 说明 |
| :--- | :--- | :--- |
| **费率** | `设置费率5%` | 设置入款费率为 5%（影响应下发金额计算） |
| **美元汇率** | `设置美元汇率7.3` | 设置 USDT 汇率，用于 `下发100u` 换算 |
| **其他汇率** | `设置比索汇率56` | 设置其他币种汇率（如马币、泰铢等） |

### 3.2 显示模式切换
| 模式 | 指令 | 效果 |
| :--- | :--- | :--- |
| **无小数模式** | `设置为无小数` | 金额取整显示（例如 100.00 -> 100） |
| **计数模式** | `设置为计数模式` | 极简模式，隐藏下发和费率详情，只显总入款 |
| **原始模式** | `设置为原始模式` | 恢复默认的详细显示模式（保留两位小数） |

### 3.3 操作员权限管理
默认情况下，只有群主和管理员可以操作机器人。如需授权群内普通成员记账：

- **添加操作人**：发送 `设置操作人 @用户`（支持同时 @多人）
- **删除操作人**：发送 `删除操作人 @用户`
- **查看列表**：发送 `显示操作人`

---

## 4. 实用工具

机器人内置了常用的汇率换算工具，方便快速计算。

### 4.1 价格计算
支持计算 **100 元人民币** 能兑换多少 USDT（基于实时汇率或预设逻辑）。

- **银行卡 (Card)**：发送 `k100`
- **支付宝 (Ali)**：发送 `z100`
- **微信 (WeChat)**：发送 `w100`

### 4.2 实时价格查询
快速查询各大通道的参考价格：
- `lk`：查询银行卡价格
- `lz`：查询支付宝价格
- `lw`：查询微信价格

---

## 5. 技术特性与说明

本机器人采用最新的技术架构，确保在高并发群组中稳定运行。

### 5.1 核心特性
- **高性能架构**：基于 Python FastAPI + SQLAlchemy 异步框架。
- **高并发支持**：
    - **Redis 缓存**：高频读取（如群组配置、权限检查）走缓存，减少数据库压力。
    - **连接池优化**：数据库开启 WAL 模式 + 连接池保活，杜绝 "Database Locked"。
- **精准时区**：全系统统一使用 **Asia/Shanghai (北京时间)**，符合东八区用户习惯。
- **监控告警**：集成 **Sentry**，实时监控生产环境错误。

### 5.2 部署说明
- **环境要求**：Python 3.10+, Redis (可选，推荐)
- **启动命令**：`uvicorn app.main:app --host 0.0.0.0 --port 8000`
- **配置文件**：请确保 `.env` 中配置了正确的 `DATABASE_URL` 和 `REDIS_URL`。

---

> 遇到问题？请联系管理员或在群内发送 `详细说明书` 获取帮助。
